<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reports</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- SheetJS (Excel export) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen">

<!-- NAVBAR -->
<nav class="bg-white shadow px-6 py-4 flex justify-between items-center">
  <div class="flex items-center gap-4">
    <img src="https://i.imgur.com/VbZKWAf.png" class="h-10" />
    <span class="text-xl font-semibold">Reports</span>
  </div>
  <div class="flex gap-4">
    <a href="dashboard.html" class="text-gray-600 hover:text-black">Dashboard</a>
    <a href="patients.html" class="text-gray-600 hover:text-black">Patients</a>
    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded">Logout</button>
  </div>
</nav>

<!-- CONTENT -->
<div class="p-6 space-y-6">

  <!-- FILTERS -->
  <div class="bg-white rounded shadow p-4 grid md:grid-cols-4 gap-4 items-end">

    <!-- CUSTOM CALENDAR -->
    <div>
      <label class="text-sm font-medium">Select Month</label>
      <select id="monthSelect" class="w-full border rounded p-2"></select>
    </div>

    <!-- VIP TOGGLE -->
    <div class="flex items-center gap-2">
      <input type="checkbox" id="vipOnly" class="h-5 w-5" />
      <label for="vipOnly" class="font-medium">VIP only</label>
    </div>

    <!-- EXPORT -->
    <div class="flex gap-2">
      <button onclick="exportExcel()" class="bg-green-600 text-white px-4 py-2 rounded">Excel</button>
      <button onclick="window.print()" class="bg-gray-700 text-white px-4 py-2 rounded">PDF</button>
    </div>

  </div>

  <!-- CHART -->
  <div class="bg-white rounded shadow p-4">
    <h2 class="font-semibold mb-4">Daily Revenue Trend</h2>
    <canvas id="dailyChart" height="120"></canvas>
  </div>

  <!-- TABLE -->
  <div class="bg-white rounded shadow p-4 overflow-x-auto">
    <table class="min-w-full text-sm" id="reportTable">
      <thead class="bg-gray-100">
        <tr>
          <th class="p-2">Date</th>
          <th class="p-2">Patient</th>
          <th class="p-2">Payment</th>
          <th class="p-2">Guarantor</th>
          <th class="p-2">Amount</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
/* ---------------- SUPABASE ---------------- */
const supabase = supabase.createClient(
  'YOUR_SUPABASE_URL'https://xpdtzvxjlguhcxkgowsg.supabase.co',
  'YOUR_SUPABASE_ANON_KEY'sb_publishable_KOm1sD7eOBpbJ_CiYtKL8w_RykN3krN',
);

/* ---------------- LOGOUT ---------------- */
async function logout() {
  await supabase.auth.signOut();
  window.location.href = 'index.html';
}

/* ---------------- MONTH DROPDOWN ---------------- */
const monthSelect = document.getElementById('monthSelect');
const months = [];

for (let y = 2024; y <= 2025; y++) {
  for (let m = 0; m < 12; m++) {
    const date = new Date(y, m, 1);
    const value = date.toISOString().slice(0, 7);
    const label = date.toLocaleString('default', { month: 'long', year: 'numeric' });
    months.push({ value, label });
  }
}

months.forEach(m => {
  const opt = document.createElement('option');
  opt.value = m.value;
  opt.textContent = m.label;
  monthSelect.appendChild(opt);
});

monthSelect.value = '2024-12';

/* ---------------- DATA LOAD ---------------- */
let chart;

async function loadReport() {
  const [year, month] = monthSelect.value.split('-');
  const start = `${year}-${month}-01T00:00:00+08`;
  const end = `${year}-${month}-31T23:59:59+08`;
  const vipOnly = document.getElementById('vipOnly').checked;

  let query = supabase
    .from('patient_records')
    .select('date, patient_name, payment_type, guarantor, amount')
    .gte('date', start)
    .lte('date', end)
    .order('date');

  if (vipOnly) query = query.eq('guarantor', 'VIP');

  const { data } = await query;

  renderTable(data || []);
  renderChart(data || []);
}

/* ---------------- TABLE ---------------- */
function renderTable(data) {
  const tbody = document.querySelector('#reportTable tbody');
  tbody.innerHTML = '';

  data.forEach(r => {
    tbody.innerHTML += `
      <tr class="border-b">
        <td class="p-2">${new Date(r.date).toLocaleDateString()}</td>
        <td class="p-2">${r.patient_name}</td>
        <td class="p-2">${r.payment_type}</td>
        <td class="p-2">${r.guarantor}</td>
        <td class="p-2 text-right">â‚±${r.amount.toLocaleString()}</td>
      </tr>`;
  });
}

/* ---------------- CHART ---------------- */
function renderChart(data) {
  const daily = {};
  data.forEach(r => {
    const d = new Date(r.date).getDate();
    daily[d] = (daily[d] || 0) + r.amount;
  });

  const labels = Object.keys(daily);
  const values = Object.values(daily);

  if (chart) chart.destroy();

  chart = new Chart(document.getElementById('dailyChart'), {
    type: 'line',
    data: {
      labels,
      datasets: [{ label: 'Daily Revenue', data: values, fill: false }]
    }
  });
}

/* ---------------- EXPORT ---------------- */
function exportExcel() {
  const table = document.getElementById('reportTable');
  const wb = XLSX.utils.table_to_book(table, { sheet: 'Report' });
  XLSX.writeFile(wb, 'monthly-report.xlsx');
}

/* ---------------- EVENTS ---------------- */
monthSelect.addEventListener('change', loadReport);
document.getElementById('vipOnly').addEventListener('change', loadReport);

loadReport();
</script>

</body>
</html>
