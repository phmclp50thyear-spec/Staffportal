<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reports</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-100 min-h-screen">

<!-- NAVBAR -->
<nav class="bg-white shadow px-6 py-4 flex justify-between items-center">
  <div class="flex items-center gap-4">
    <img src="https://i.imgur.com/VbZKWAf.png" class="h-10" />
    <span class="text-xl font-semibold">Reports</span>
  </div>
  <div class="flex gap-4">
    <a href="dashboard.html" class="text-gray-600 hover:text-black">Dashboard</a>
    <a href="patients.html" class="text-gray-600 hover:text-black">Patients</a>
    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded">
      Logout
    </button>
  </div>
</nav>

<!-- CONTENT -->
<div class="p-6 space-y-6">

  <!-- FILTERS -->
  <div class="bg-white rounded shadow p-4 grid md:grid-cols-4 gap-4 items-end">

    <div>
      <label class="text-sm font-medium">Select Month</label>
      <select id="monthSelect" class="w-full border rounded p-2"></select>
    </div>

    <div class="flex items-center gap-2">
      <input type="checkbox" id="vipOnly" class="h-5 w-5" />
      <label class="font-medium">VIP only</label>
    </div>

    <div class="flex gap-2">
      <button onclick="exportExcel()" class="bg-green-600 text-white px-4 py-2 rounded">
        Excel
      </button>
      <button onclick="window.print()" class="bg-gray-700 text-white px-4 py-2 rounded">
        PDF
      </button>
    </div>

  </div>

  <!-- CHART -->
  <div class="bg-white rounded shadow p-4">
    <h2 class="font-semibold mb-4">Daily Revenue Trend</h2>
    <canvas id="dailyChart" height="120"></canvas>
  </div>

  <!-- TABLE -->
  <div class="bg-white rounded shadow p-4 overflow-x-auto">
    <table class="min-w-full text-sm" id="reportTable">
      <thead class="bg-gray-100">
        <tr>
          <th class="p-2">Date</th>
          <th class="p-2">Patient</th>
          <th class="p-2">Payment</th>
          <th class="p-2">Guarantor</th>
          <th class="p-2 text-right">Amount</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
/* ================= SUPABASE ================= */
const supabase = window.supabase.createClient(
  'https://xpdtzvxjlguhcxkgowsg.supabase.co',
  'sb_publishable_KOm1sD7eOBpbJ_CiYtKL8w_RykN3krN'
);

/* ================= LOGOUT ================= */
async function logout() {
  await supabase.auth.signOut();
  location.href = 'index.html';
}

/* ================= MONTH DROPDOWN ================= */
const monthSelect = document.getElementById('monthSelect');

for (let y = 2024; y <= 2025; y++) {
  for (let m = 0; m < 12; m++) {
    const d = new Date(y, m, 1);
    const opt = document.createElement('option');
    opt.value = d.toISOString().slice(0, 7);
    opt.textContent = d.toLocaleString('default', { month: 'long', year: 'numeric' });
    monthSelect.appendChild(opt);
  }
}
monthSelect.value = '2024-12';

/* ================= LOAD REPORT ================= */
let chart;

async function loadReport() {
  const [year, month] = monthSelect.value.split('-');
  const start = `${year}-${month}-01T00:00:00+08`;
  const endDate = new Date(year, month, 0).getDate();
  const end = `${year}-${month}-${endDate}T23:59:59+08`;
  const vipOnly = document.getElementById('vipOnly').checked;

  let query = supabase
    .from('patient_records')
    .select('date, patient_name, payment_type, guarantor, amount')
    .gte('date', start)
    .lte('date', end)
    .order('date');

  if (vipOnly) query = query.eq('guarantor', 'VIP');

  const { data, error } = await query;

  if (error) {
    console.error('Supabase error:', error);
    return;
  }

  renderTable(data);
  renderChart(data);
}

/* ================= TABLE ================= */
function renderTable(data) {
  const tbody = document.querySelector('#reportTable tbody');
  tbody.innerHTML = '';

  data.forEach(r => {
    tbody.innerHTML += `
      <tr class="border-b">
        <td class="p-2">${new Date(r.date).toLocaleDateString()}</td>
        <td class="p-2">${r.patient_name}</td>
        <td class="p-2">${r.payment_type}</td>
        <td class="p-2">${r.guarantor}</td>
        <td class="p-2 text-right">â‚±${r.amount.toLocaleString()}</td>
      </tr>
    `;
  });
}

/* ================= CHART ================= */
function renderChart(data) {
  const daily = {};
  data.forEach(r => {
    const d = new Date(r.date).getDate();
    daily[d] = (daily[d] || 0) + r.amount;
  });

  if (chart) chart.destroy();

  chart = new Chart(document.getElementById('dailyChart'), {
    type: 'line',
    data: {
      labels: Object.keys(daily),
      datasets: [{
        label: 'Daily Revenue',
        data: Object.values(daily),
        tension: 0.4
      }]
    }
  });
}

/* ================= EXPORT ================= */
function exportExcel() {
  const wb = XLSX.utils.table_to_book(
    document.getElementById('reportTable'),
    { sheet: 'Report' }
  );
  XLSX.writeFile(wb, 'monthly-report.xlsx');
}

/* ================= EVENTS ================= */
monthSelect.addEventListener('change', loadReport);
document.getElementById('vipOnly').addEventListener('change', loadReport);

loadReport();
</script>

</body>
</html>
