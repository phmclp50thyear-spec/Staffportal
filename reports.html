<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Staff Portal | Reports</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background-color: #f1f5f9; }
    .card { background: white; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  </style>
</head>
<body class="p-6">

  <div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-sm">
      <h1 class="text-2xl font-black text-slate-800">CLINICAL ANALYTICS</h1>
      <a href="dashboard.html" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold">Back</a>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      <div class="card bg-emerald-700 text-white">
        <p class="text-xs font-bold uppercase opacity-70">Revenue</p>
        <h2 id="rev" class="text-2xl font-black">₱0.00</h2>
      </div>
      <div class="card">
        <p class="text-xs font-bold text-slate-400 uppercase">Census</p>
        <h2 id="cen" class="text-2xl font-black text-slate-800">0</h2>
      </div>
      <div class="card">
        <p class="text-xs font-bold text-slate-400 uppercase">Average</p>
        <h2 id="avg" class="text-2xl font-black text-slate-800">₱0.00</h2>
      </div>
      <div class="card">
        <p class="text-xs font-bold text-slate-400 uppercase">Highest</p>
        <h2 id="max" class="text-2xl font-black text-slate-800">₱0.00</h2>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div class="card">
        <h3 class="font-bold mb-4 text-slate-500">AGE BRACKETS</h3>
        <canvas id="ageChart"></canvas>
      </div>
      <div class="card">
        <h3 class="font-bold mb-4 text-slate-500">GENDER SPLIT</h3>
        <div class="max-w-[300px] mx-auto">
          <canvas id="genChart"></canvas>
        </div>
      </div>
    </div>
    
    <div id="debug" class="mt-10 p-4 text-xs text-slate-400 font-mono italic"></div>
  </div>

  <script>
    // 1. Setup Supabase
    const supabase = window.supabase.createClient(
      'https://xpdtzvxjlguhcxkgowsg.supabase.co', 
      'sb_publishable_KOm1sD7eOBpbJ_CiYtKL8w_RykN3krN'
    );

    async function runAnalytics() {
      const debug = document.getElementById('debug');
      debug.innerText = "Script started...";

      try {
        // 2. Fetch Data
        debug.innerText = "Connecting to table...";
        const { data, error } = await supabase.from('patient_records').select('*');

        if (error) {
          debug.innerText = "Supabase Error: " + error.message;
          return;
        }

        if (!data || data.length === 0) {
          debug.innerText = "Connected! But no data found in patient_records table.";
          return;
        }

        debug.innerText = `Success! Processing ${data.length} records.`;

        // 3. Simple Math
        const total = data.reduce((s, r) => s + (r.amount || 0), 0);
        const max = Math.max(...data.map(r => r.amount || 0));
        
        document.getElementById('rev').innerText = "₱" + total.toLocaleString();
        document.getElementById('cen').innerText = data.length;
        document.getElementById('avg').innerText = "₱" + (total / data.length).toLocaleString();
        document.getElementById('max').innerText = "₱" + max.toLocaleString();

        // 4. Group Data
        const ages = { 'Youth': 0, 'Adult': 0, 'Senior': 0 };
        const genders = { 'Male': 0, 'Female': 0 };

        data.forEach(r => {
          if (r.age < 19) ages['Youth']++;
          else if (r.age < 60) ages['Adult']++;
          else ages['Senior']++;

          if(r.gender === 'Male') genders['Male']++;
          if(r.gender === 'Female') genders['Female']++;
        });

        // 5. Draw Charts
        new Chart(document.getElementById('ageChart'), {
          type: 'bar',
          data: {
            labels: Object.keys(ages),
            datasets: [{ label: 'Patients', data: Object.values(ages), backgroundColor: '#047857' }]
          }
        });

        new Chart(document.getElementById('genChart'), {
          type: 'doughnut',
          data: {
            labels: Object.keys(genders),
            datasets: [{ data: Object.values(genders), backgroundColor: ['#047857', '#3b82f6'] }]
          }
        });

      } catch (e) {
        debug.innerText = "Crash Error: " + e.message;
      }
    }

    // Run after 1 second to ensure Chart.js is ready
    setTimeout(runAnalytics, 1000);
  </script>
</body>
</html>
