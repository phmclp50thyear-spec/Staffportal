<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Staff Portal | Reports</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">

  <nav class="bg-white shadow-sm border-b border-gray-200 h-20 flex items-center px-6">
    <div class="max-w-7xl mx-auto w-full flex justify-between items-center">
      <div class="flex items-center gap-4">
        <img src="https://i.imgur.com/VbZKWAf.png" alt="Logo" class="h-10 w-auto" />
        <span class="font-extrabold text-gray-900 tracking-tight">Analytics Report</span>
      </div>
      <a href="dashboard.html" class="text-sm font-bold text-[#007941] hover:underline">← Back to Dashboard</a>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto p-6 space-y-8">
    
    <div id="loadingState" class="text-center py-20 text-gray-400 font-bold animate-pulse">
        Fetching clinical data...
    </div>

    <div id="reportContent" class="hidden space-y-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm">
            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Total Revenue</p>
            <h2 id="totalRevenue" class="text-3xl font-black text-[#007941]">₱0.00</h2>
          </div>
          <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm">
            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Total Census</p>
            <h2 id="totalCensus" class="text-3xl font-black text-gray-900">0</h2>
          </div>
          <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm">
            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Avg per Patient</p>
            <h2 id="avgRevenue" class="text-3xl font-black text-blue-600">₱0.00</h2>
          </div>
          <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm">
            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Highest Bill</p>
            <h2 id="maxBill" class="text-3xl font-black text-orange-600">₱0.00</h2>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm">
            <h3 class="font-black text-gray-900 mb-6 uppercase text-xs tracking-widest text-center">Census by Gender</h3>
            <div class="max-w-[300px] mx-auto"><canvas id="genderChart"></canvas></div>
          </div>

          <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm">
            <h3 class="font-black text-gray-900 mb-6 uppercase text-xs tracking-widest text-center">Revenue by Type</h3>
            <div class="max-w-[300px] mx-auto"><canvas id="paymentChart"></canvas></div>
          </div>

          <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm col-span-1 md:col-span-2">
            <h3 class="font-black text-gray-900 mb-6 uppercase text-xs tracking-widest">Patient Census by Age Bracket</h3>
            <canvas id="ageChart" style="max-height: 300px;"></canvas>
          </div>
        </div>
    </div>
  </main>

  <script>
  { // This opening brace creates a protected scope
    const _URL = 'https://xpdtzvxjlguhcxkgowsg.supabase.co';
    const _KEY = 'sb_publishable_KOm1sD7eOBpbJ_CiYtKL8w_RykN3krN';
    const supabase = window.supabase.createClient(_URL, _KEY);

    async function loadReports() {
      try {
        console.log("Verifying session...");
        
        // 1. Ensure user is authenticated
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          window.location.replace("index.html");
          return;
        }

        // 2. Fetch the records
        console.log("Fetching patient data...");
        const { data, error } = await supabase.from('patient_records').select('*');
        
        if (error) {
          console.error("Database Error:", error.message);
          document.getElementById('loadingState').innerText = "Database Error: " + error.message;
          return;
        }

        if (!data || data.length === 0) {
          document.getElementById('loadingState').innerText = "No records found. Please add patients in the dashboard.";
          return;
        }

        // 3. Process Calculations
        const totalRev = data.reduce((sum, r) => sum + (r.amount || 0), 0);
        const census = data.length;
        const maxBill = Math.max(...data.map(r => r.amount || 0));

        // Update UI Stats
        document.getElementById('totalRevenue').innerText = `₱${totalRev.toLocaleString()}`;
        document.getElementById('totalCensus').innerText = census;
        document.getElementById('avgRevenue').innerText = `₱${(totalRev / census).toLocaleString(undefined, {maximumFractionDigits:0})}`;
        document.getElementById('maxBill').innerText = `₱${maxBill.toLocaleString()}`;

        // 4. Group Data for Charts
        const genderCounts = { Male: 0, Female: 0, Other: 0 };
        const payRev = { HMO: 0, Cash: 0, Company: 0 };
        const ageBrackets = { '0-18': 0, '19-35': 0, '36-50': 0, '51-65': 0, '65+': 0 };

        data.forEach(r => {
          if (genderCounts[r.gender] !== undefined) genderCounts[r.gender]++;
          if (payRev[r.payment_type] !== undefined) payRev[r.payment_type] += (r.amount || 0);
          
          const a = r.age;
          if (a <= 18) ageBrackets['0-18']++;
          else if (a <= 35) ageBrackets['19-35']++;
          else if (a <= 50) ageBrackets['36-50']++;
          else if (a <= 65) ageBrackets['51-65']++;
          else ageBrackets['65+']++;
        });

        // 5. Reveal Content & Render Charts
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('reportContent').classList.remove('hidden');

        // Render Gender Doughnut
        new Chart(document.getElementById('genderChart'), {
          type: 'doughnut',
          data: {
            labels: Object.keys(genderCounts),
            datasets: [{ 
              data: Object.values(genderCounts), 
              backgroundColor: ['#007941', '#3b82f6', '#cbd5e1'] 
            }]
          }
        });

        // Render Payment Pie
        new Chart(document.getElementById('paymentChart'), {
          type: 'pie',
          data: {
            labels: Object.keys(payRev),
            datasets: [{ 
              data: Object.values(payRev), 
              backgroundColor: ['#3b82f6', '#f59e0b', '#8b5cf6'] 
            }]
          }
        });

        // Render Age Bar
        new Chart(document.getElementById('ageChart'), {
          type: 'bar',
          data: {
            labels: Object.keys(ageBrackets),
            datasets: [{ 
              label: 'Total Patients', 
              data: Object.values(ageBrackets), 
              backgroundColor: '#007941', 
              borderRadius: 8 
            }]
          },
          options: {
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
          }
        });

      } catch (err) {
        console.error("Critical Error:", err);
        document.getElementById('loadingState').innerText = "Error: " + err.message;
      }
    }

    // Run the app
    loadReports();
  } // Closing brace for the protected scope
</script>
</body>
</html>


