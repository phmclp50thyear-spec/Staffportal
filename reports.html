<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Staff Portal | Reports</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    background: #f8fafc;
    font-family: ui-sans-serif, system-ui;
  }
  .card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 1.25rem;
    padding: 1.5rem;
  }
  .metric {
    font-weight: 900;
    font-size: 1.75rem;
  }
  .delta-up { color: #059669; }
  .delta-down { color: #dc2626; }
</style>
</head>

<body>

<!-- NAV -->
<nav class="bg-white border-b sticky top-0 z-40">
  <div class="max-w-7xl mx-auto h-16 px-6 flex items-center justify-between">
    <h1 class="font-black tracking-tight">Clinical Reports</h1>
    <div class="flex gap-6 text-sm font-bold">
      <a href="home.html" class="text-gray-400">Home</a>
      <a href="dashboard.html" class="text-gray-400">Records</a>
      <a href="reports.html" class="text-emerald-600 border-b-2 border-emerald-600">Reports</a>
    </div>
    <button onclick="logout()" class="text-xs font-bold text-red-600">Logout</button>
  </div>
</nav>

<main class="max-w-7xl mx-auto p-6 space-y-8">

  <div id="loading" class="text-center text-gray-400 font-bold py-20">
    Loading analytics…
  </div>

  <div id="content" class="hidden space-y-10">

    <!-- KPI -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
      <div class="card">
        <p class="text-xs text-gray-400 uppercase font-bold">Total Revenue</p>
        <div id="totalRevenue" class="metric">₱0</div>
      </div>
      <div class="card">
        <p class="text-xs text-gray-400 uppercase font-bold">Total Census</p>
        <div id="totalCensus" class="metric">0</div>
      </div>
      <div class="card">
        <p class="text-xs text-gray-400 uppercase font-bold">Avg / Patient</p>
        <div id="avgRevenue" class="metric">₱0</div>
      </div>
      <div class="card">
        <p class="text-xs text-gray-400 uppercase font-bold">Highest Bill</p>
        <div id="maxBill" class="metric">₱0</div>
      </div>
    </div>

    <!-- VARIANCE -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="card">
        <p class="text-xs font-bold uppercase text-gray-400 mb-3">Revenue Variance</p>
        <p id="revYear" class="font-bold"></p>
        <p id="revMonth" class="font-bold"></p>
      </div>
      <div class="card">
        <p class="text-xs font-bold uppercase text-gray-400 mb-3">Census Variance</p>
        <p id="cenYear" class="font-bold"></p>
        <p id="cenMonth" class="font-bold"></p>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="card lg:col-span-2">
        <canvas id="ageChart"></canvas>
      </div>
      <div class="card">
        <canvas id="genderChart"></canvas>
      </div>
    </div>

    <div class="card">
      <canvas id="paymentChart"></canvas>
    </div>

  </div>
</main>

<script>
const supabase = window.supabase.createClient(
  'https://xpdtzvxjlguhcxkgowsg.supabase.co',
  'sb_publishable_KOm1sD7eOBpbJ_CiYtKL8w_RykN3krN'
);

async function loadReports() {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) return location.replace("index.html");

  const { data } = await supabase.from('patient_records').select('*');
  if (!data || data.length === 0) return;

  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();

  const sum = arr => arr.reduce((s,r)=>s+(r.amount||0),0);

  const curYear = data.filter(r => new Date(r.date).getFullYear() === year);
  const lastYear = data.filter(r => new Date(r.date).getFullYear() === year-1);

  const curMonth = data.filter(r => {
    const d = new Date(r.date);
    return d.getFullYear() === year && d.getMonth() === month;
  });

  const lastMonth = data.filter(r => {
    const d = new Date(r.date);
    return d.getFullYear() === year-1 && d.getMonth() === month;
  });

  function variance(cur, prev) {
    const diff = cur - prev;
    const pct = prev ? (diff / prev) * 100 : 0;
    return { diff, pct };
  }

  const revY = variance(sum(curYear), sum(lastYear));
  const revM = variance(sum(curMonth), sum(lastMonth));
  const cenY = variance(curYear.length, lastYear.length);
  const cenM = variance(curMonth.length, lastMonth.length);

  const fmt = v => v >= 0 ? `+${v}` : v;

  document.getElementById('revYear').innerHTML =
    `Year: <span class="${revY.diff>=0?'delta-up':'delta-down'}">
    ₱${fmt(revY.diff.toLocaleString())} (${fmt(revY.pct.toFixed(1))}%)
    </span>`;

  document.getElementById('revMonth').innerHTML =
    `Month: <span class="${revM.diff>=0?'delta-up':'delta-down'}">
    ₱${fmt(revM.diff.toLocaleString())} (${fmt(revM.pct.toFixed(1))}%)
    </span>`;

  document.getElementById('cenYear').innerHTML =
    `Year: <span class="${cenY.diff>=0?'delta-up':'delta-down'}">
    ${fmt(cenY.diff)} (${fmt(cenY.pct.toFixed(1))}%)
    </span>`;

  document.getElementById('cenMonth').innerHTML =
    `Month: <span class="${cenM.diff>=0?'delta-up':'delta-down'}">
    ${fmt(cenM.diff)} (${fmt(cenM.pct.toFixed(1))}%)
    </span>`;

  document.getElementById('totalRevenue').innerText = `₱${sum(data).toLocaleString()}`;
  document.getElementById('totalCensus').innerText = data.length;
  document.getElementById('avgRevenue').innerText = `₱${(sum(data)/data.length).toFixed(0)}`;
  document.getElementById('maxBill').innerText = `₱${Math.max(...data.map(r=>r.amount||0)).toLocaleString()}`;

  document.getElementById('loading').classList.add('hidden');
  document.getElementById('content').classList.remove('hidden');
}

loadReports();

window.logout = async () => {
  await supabase.auth.signOut();
  location.replace("index.html");
};
</script>

</body>
</html>
