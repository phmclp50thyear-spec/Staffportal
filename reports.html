<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Executive Health | Reports</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
    .chart-container { position: relative; height: 300px; width: 100%; }
    /* PHMC Scrollbar style */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    
    /* Active Nav State */
    .nav-active { color: #4f46e5; border-bottom: 2px solid #4f46e5; }
    .month-btn.active { background: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); }
  </style>
</head>
<body class="min-h-screen pb-20">

  <nav class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-slate-200 p-4 shadow-sm">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-8">
        <h1 class="font-black text-indigo-600 tracking-tighter text-xl uppercase italic">PHMC</h1>
        <div class="flex gap-6">
          <a href="dashboard.html" class="text-sm font-bold text-slate-400 hover:text-indigo-600 transition-colors uppercase tracking-widest">Records</a>
          <a href="reports.html" class="text-sm font-bold nav-active transition-colors uppercase tracking-widest pb-1">Reports</a>
        </div>
      </div>
      <div class="flex gap-3">
        <button onclick="downloadCSV()" class="hidden md:block text-[10px] font-black px-4 py-2 uppercase tracking-widest text-slate-500 hover:bg-slate-100 rounded-full transition">Export</button>
        <button onclick="logout()" class="bg-slate-100 text-[10px] font-black px-4 py-2 rounded-full uppercase tracking-widest hover:bg-red-50 hover:text-red-600 transition">Logout</button>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto p-4 md:p-8 space-y-8">
    
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
      <div class="bg-white shadow-lg rounded-3xl p-6 border-l-4 border-indigo-600">
        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Revenue</p>
        <h3 id="valCurrentYear" class="text-2xl md:text-3xl font-black italic">₱0</h3>
        <div id="revGrowthBadge" class="mt-2"></div>
      </div>
      <div class="bg-white shadow-lg rounded-3xl p-6 border-l-4 border-emerald-500">
        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Census</p>
        <h3 id="valCensusCurrent" class="text-2xl md:text-3xl font-black italic text-emerald-500">0</h3>
        <div id="cenGrowthBadge" class="mt-2"></div>
      </div>
      <div class="bg-white shadow-lg rounded-3xl p-6 border-l-4 border-amber-500">
        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">VIP Patients</p>
        <h3 id="vipCount" class="text-2xl md:text-3xl font-black italic text-amber-500">0</h3>
      </div>
      <div class="bg-white shadow-lg rounded-3xl p-6 border-l-4 border-slate-800">
        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Daily snapshot</p>
        <input type="date" id="dateSelector" onchange="handleDateChange(this.value)" class="text-sm font-bold bg-transparent outline-none w-full">
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      <div class="lg:col-span-3 bg-white shadow-xl rounded-3xl p-6 border border-slate-100">
        <h4 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-6">Filter by Month</h4>
        <div id="monthPicker" class="space-y-1 max-h-[400px] overflow-y-auto pr-2"></div>
      </div>
      <div class="lg:col-span-9 bg-white shadow-xl rounded-3xl p-8 border border-slate-100">
        <div class="flex justify-between items-center mb-6">
            <h4 class="text-xs font-black text-slate-400 uppercase tracking-[0.3em]" id="filterSummary">Overall View</h4>
            <span class="text-[10px] font-bold text-slate-300 italic">Click chart points to drill down</span>
        </div>
        <div class="chart-container"><canvas id="revLineChart"></canvas></div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="bg-white shadow-xl rounded-3xl p-8 border border-slate-100">
            <h4 class="text-xs font-black text-slate-400 uppercase tracking-[0.3em] mb-6 text-center">Payment Mix</h4>
            <div class="chart-container"><canvas id="paymentChart"></canvas></div>
        </div>
        <div class="lg:col-span-2 bg-white shadow-xl rounded-3xl overflow-hidden border border-slate-100">
            <div class="p-6 bg-slate-50 border-b border-slate-100">
                <h4 class="text-xs font-black text-slate-400 uppercase tracking-[0.3em]">HMO Performance Ranking</h4>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead>
                        <tr class="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                            <th class="px-8 py-4">Guarantor Name</th>
                            <th class="px-8 py-4 text-center">Census</th>
                            <th class="px-8 py-4 text-right">Revenue</th>
                        </tr>
                    </thead>
                    <tbody id="hmoTableBody" class="divide-y divide-slate-50">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white shadow-xl rounded-3xl p-8 border border-slate-100">
            <h4 class="text-xs font-black text-slate-400 uppercase tracking-[0.3em] mb-6">Patient Age Brackets</h4>
            <div class="chart-container"><canvas id="ageChart"></canvas></div>
        </div>
        <div class="bg-white shadow-xl rounded-3xl p-8 border border-slate-100 text-center">
            <h4 class="text-xs font-black text-slate-400 uppercase tracking-[0.3em] mb-6">Gender Distribution</h4>
            <div class="chart-container"><canvas id="genderChart"></canvas></div>
        </div>
    </div>

  </main>

  <script>
    const db = window.supabase.createClient('https://xpdtzvxjlguhcxkgowsg.supabase.co','sb_publishable_KOm1sD7eOBpbJ_CiYtKL8w_RykN3krN');
    let globalData = [], currentViewData = [], latestYear, prevYear, selectedMonthIndex = null, selectedDate = null;
    const monthsFull = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const monthsShort = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    async function init() {
        const { data } = await db.from('patient_records').select('*');
        globalData = data || [];
        const years = [...new Set(globalData.map(r => new Date(r.date).getFullYear()))].sort((a,b) => b-a);
        latestYear = years[0] || 2024;
        prevYear = latestYear - 1;
        renderMonthPicker(); 
        updateDashboard();
        document.getElementById('loadingState')?.remove();
    }

    function updateDashboard() {
        const filterFn = (yr) => globalData.filter(r => {
            const d = new Date(r.date);
            const matchesYear = d.getFullYear() === yr;
            const matchesMonth = selectedMonthIndex === null || d.getMonth() === selectedMonthIndex;
            const matchesDay = !selectedDate || d.toISOString().split('T')[0] === selectedDate;
            return matchesYear && matchesMonth && matchesDay;
        });

        currentViewData = filterFn(latestYear);
        const pre = filterFn(prevYear);

        const revC = currentViewData.reduce((a, r) => a + (parseFloat(r.amount) || 0), 0);
        const revP = pre.reduce((a, r) => a + (parseFloat(r.amount) || 0), 0);
        const cenC = currentViewData.length;
        const cenP = pre.length;

        document.getElementById('valCurrentYear').innerText = `₱${revC.toLocaleString()}`;
        document.getElementById('valCensusCurrent').innerText = cenC.toLocaleString();
        document.getElementById('vipCount').innerText = currentViewData.filter(r => r.guarantor?.toLowerCase() === 'vip').length;

        // Growth badges (PHMC Colors)
        const calcG = (c, p, id) => {
            const pct = p > 0 ? ((c - p) / p * 100).toFixed(1) : '0';
            const color = pct >= 0 ? 'text-emerald-500' : 'text-red-500';
            document.getElementById(id).innerHTML = `<span class="text-[10px] font-black ${color}">${pct >= 0 ? '▲' : '▼'} ${Math.abs(pct)}% VS LAST YEAR</span>`;
        };
        calcG(revC, revP, 'revGrowthBadge'); calcG(cenC, cenP, 'cenGrowthBadge');

        // HMO Table
        const hmoStats = {};
        currentViewData.filter(r => r.payment_type === 'HMO').forEach(r => {
            const n = r.guarantor || 'Unspecified';
            if(!hmoStats[n]) hmoStats[n] = { c: 0, r: 0 };
            hmoStats[n].c++; hmoStats[n].r += (parseFloat(r.amount) || 0);
        });
        const sortedHMO = Object.entries(hmoStats).sort((a,b) => b[1].r - a[1].r);
        document.getElementById('hmoTableBody').innerHTML = sortedHMO.map(([n,s]) => `
            <tr class="hover:bg-slate-50 transition">
                <td class="px-8 py-4 font-bold text-slate-700">${n}</td>
                <td class="px-8 py-4 text-center font-black text-indigo-600">${s.c}</td>
                <td class="px-8 py-4 text-right font-black italic text-emerald-500">₱${s.r.toLocaleString()}</td>
            </tr>
        `).join('') || '<tr><td colspan="3" class="p-8 text-center text-slate-300 font-bold italic uppercase">No HMO entries found</td></tr>';

        renderCharts(currentViewData, revC, cenC);
    }

    function renderCharts(cur, revC, cenC) {
        Chart.helpers.each(Chart.instances, (i) => i.destroy());
        Chart.defaults.font.family = "'Inter', sans-serif";

        const paySplit = {
            Cash: cur.filter(r => r.payment_type === 'Cash').length,
            HMO: cur.filter(r => r.payment_type === 'HMO').length,
            Company: cur.filter(r => r.payment_type === 'Company').length
        };

        // Payment Chart (PHMC Vibes)
        new Chart(document.getElementById('paymentChart'), {
            type: 'doughnut',
            data: { labels: ['CASH', 'HMO', 'COMPANY'], datasets: [{ data: [paySplit.Cash, paySplit.HMO, paySplit.Company], backgroundColor: ['#10b981', '#6366f1', '#f59e0b'], borderWidth: 0 }]},
            options: { cutout: '80%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { weight: 'bold', size: 10 } } } }}
        });

        // Revenue Line
        let labels = monthsShort;
        let trend = monthsShort.map((_, i) => globalData.filter(r => new Date(r.date).getFullYear() === latestYear && new Date(r.date).getMonth() === i).reduce((a,r) => a + (parseFloat(r.amount) || 0), 0));
        new Chart(document.getElementById('revLineChart'), {
            type: 'line',
            data: { labels, datasets: [{ data: trend, borderColor: '#6366f1', backgroundColor: 'rgba(99, 102, 241, 0.05)', fill: true, tension: 0.4, borderWidth: 4, pointRadius: 4 }]},
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { display: false } }, x: { grid: { display: false } } } }
        });

        // Age Chart
        new Chart(document.getElementById('ageChart'), {
            type: 'bar',
            data: { 
                labels: ['0-18','19-35','36-50','51-65','66+'], 
                datasets: [{ 
                    data: [cur.filter(r=>r.age<=18).length, cur.filter(r=>r.age>18 && r.age<=35).length, cur.filter(r=>r.age>35 && r.age<=50).length, cur.filter(r=>r.age>50 && r.age<=65).length, cur.filter(r=>r.age>65).length], 
                    backgroundColor: '#6366f1', borderRadius: 20 
                }] 
            },
            options: { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { display: false } } } }
        });

        // Gender Chart
        new Chart(document.getElementById('genderChart'), {
            type: 'pie',
            data: { labels: ['MALE','FEMALE'], datasets: [{ data: [cur.filter(r=>r.gender==='Male').length, cur.filter(r=>r.gender==='Female').length], backgroundColor: ['#2dd4bf','#0ea5e9'] }] },
            options: { plugins: { legend: { position: 'bottom' } } }
        });
    }

    function renderMonthPicker() {
        const p = document.getElementById('monthPicker'); p.innerHTML = '';
        const allBtn = document.createElement('button');
        allBtn.className = `month-btn w-full text-left px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition ${selectedMonthIndex === null && !selectedDate ? 'active' : 'text-slate-400 hover:bg-slate-50'}`;
        allBtn.innerText = 'All Months';
        allBtn.onclick = () => { selectedMonthIndex = null; selectedDate = null; updateDashboard(); renderMonthPicker(); };
        p.appendChild(allBtn);
        monthsFull.forEach((m, i) => {
            const btn = document.createElement('button');
            btn.className = `month-btn w-full text-left px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition ${i === selectedMonthIndex ? 'active' : 'text-slate-400 hover:bg-slate-50'}`;
            btn.innerText = m;
            btn.onclick = () => { selectedMonthIndex = i; selectedDate = null; updateDashboard(); renderMonthPicker(); };
            p.appendChild(btn);
        });
    }

    function handleDateChange(v) { selectedDate = v; selectedMonthIndex = null; updateDashboard(); renderMonthPicker(); }
    function logout() { window.location.href = "index.html"; }
    init();
  </script>
</body>
</html>
